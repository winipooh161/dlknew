class n{constructor(){this.hasInitialized=!1,this.notifications=[],this.user=null,this.channels={}}init(){this.hasInitialized||(this.hasInitialized=!0,this.user=this.getUserInfo(),setTimeout(()=>{this.setupEventListeners()},2e3))}getUserInfo(){if(window.Laravel&&window.Laravel.user)return window.Laravel.user;try{const t=localStorage.getItem("user_data");if(t)return JSON.parse(t)}catch(t){console.warn("Ошибка при получении данных пользователя из localStorage:",t)}return null}setupEventListeners(){if(!window.Echo||!this.user){console.warn("Echo или данные пользователя не доступны для настройки уведомлений");return}try{this.user.id&&this.setupPrivateChannel(`user.${this.user.id}`),this.setupPublicChannel("notifications")}catch(t){console.error("Ошибка при настройке слушателей уведомлений:",t)}}setupPrivateChannel(t){if(!window.Echo||typeof window.Echo.private!="function"){console.warn(`Не удалось подписаться на приватный канал ${t}: Echo не инициализирован корректно`);return}setTimeout(()=>{try{const i=window.Echo.private(t);this.channels[t]=i,i.listen(".notification.received",o=>{this.handleNotification(o)}),console.log(`Подписка на приватный канал ${t} выполнена`)}catch(i){console.error(`Ошибка при подписке на приватный канал ${t}:`,i)}},1e3)}setupPublicChannel(t){if(!window.Echo||typeof window.Echo.channel!="function"){console.warn(`Не удалось подписаться на публичный канал ${t}: Echo не инициализирован корректно`);return}try{const i=window.Echo.channel(t);this.channels[t]=i,i.listen(".broadcast.message",o=>{this.handleBroadcastMessage(o)}),console.log(`Подписка на публичный канал ${t} выполнена`)}catch(i){console.error(`Ошибка при подписке на публичный канал ${t}:`,i)}}handleNotification(t){console.log("Получено уведомление:",t),this.notifications.push(t);try{this.showBrowserNotification(t.title||"Новое уведомление",t.message||t.body||"",t.data||{})}catch(i){console.error("Ошибка при отображении уведомления:",i)}this.triggerNotificationEvent(t)}showBrowserNotification(t,i,o={}){if(!("Notification"in window)){console.log("Этот браузер не поддерживает уведомления");return}if(Notification.permission==="granted"){const e=new Notification(t,{body:i,icon:"/img/logo.png"});e.onclick=function(){window.focus(),o.url&&window.open(o.url,"_blank"),e.close()}}else Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{e==="granted"&&this.showBrowserNotification(t,i,o)})}handleBroadcastMessage(t){if(console.log("Получено широковещательное сообщение:",t),t.recipient_ids&&Array.isArray(t.recipient_ids)&&(!this.user||!t.recipient_ids.includes(this.user.id))){console.log("Сообщение не предназначено для текущего пользователя");return}this.showBrowserNotification(t.title||"Уведомление",t.body||t.text||"",t.data||{}),this.triggerBroadcastEvent(t)}triggerNotificationEvent(t){const i=new CustomEvent("notification:received",{detail:t});document.dispatchEvent(i)}triggerBroadcastEvent(t){const i=new CustomEvent("broadcast:received",{detail:t});document.dispatchEvent(i)}}const r=new n;document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{r.init()},1500)});
