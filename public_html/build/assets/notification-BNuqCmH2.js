class s{constructor(){this.hasInitialized=!1,this.notifications=[],this.user=null,this.channels={}}init(){this.hasInitialized||(this.hasInitialized=!0,this.user=this.getUserInfo(),setTimeout(()=>{this.setupEventListeners()},2e3))}getUserInfo(){if(window.Laravel&&window.Laravel.user)return window.Laravel.user;try{const i=localStorage.getItem("user_data");if(i)return JSON.parse(i)}catch(i){console.warn("Ошибка при получении данных пользователя из localStorage:",i)}return null}setupEventListeners(){if(!window.Echo||!this.user){console.warn("Echo или данные пользователя не доступны для настройки уведомлений");return}try{this.user.id&&this.setupPrivateChannel(`user.${this.user.id}`),this.setupPublicChannel("notifications")}catch(i){console.error("Ошибка при настройке слушателей уведомлений:",i)}}setupPrivateChannel(i){if(!window.Echo||typeof window.Echo.private!="function"){console.warn(`Не удалось подписаться на приватный канал ${i}: Echo не инициализирован корректно`);return}setTimeout(()=>{try{const o=window.Echo.private(i);this.channels[i]=o,o.listen(".notification.received",e=>{this.handleNotification(e)}),console.log(`Подписка на приватный канал ${i} выполнена`)}catch(o){console.error(`Ошибка при подписке на приватный канал ${i}:`,o)}},1e3)}setupPublicChannel(i){if(!window.Echo||typeof window.Echo.channel!="function"){console.warn(`Не удалось подписаться на публичный канал ${i}: Echo не инициализирован корректно`);return}try{const o=window.Echo.channel(i);this.channels[i]=o,o.listen(".broadcast.message",e=>{this.handleBroadcastMessage(e)}),console.log(`Подписка на публичный канал ${i} выполнена`)}catch(o){console.error(`Ошибка при подписке на публичный канал ${i}:`,o)}}handleNotification(i){console.log("Получено уведомление:",i),this.notifications.push(i);try{this.showBrowserNotification(i.title||"Новое уведомление",i.message||i.body||"",i.data||{})}catch(o){console.error("Ошибка при отображении уведомления:",o)}this.triggerNotificationEvent(i)}showBrowserNotification(i,o,e={}){if(!("Notification"in window)){console.log("Этот браузер не поддерживает уведомления");return}if(Notification.permission==="granted"){const n=new Notification(i,{body:o,icon:"/img/logo.png"});n.onclick=function(){window.focus(),e.url&&window.open(e.url,"_blank"),n.close()}}else Notification.permission!=="denied"&&Notification.requestPermission().then(n=>{n==="granted"&&this.showBrowserNotification(i,o,e)})}handleBroadcastMessage(i){if(console.log("Получено широковещательное сообщение:",i),i.recipient_ids&&Array.isArray(i.recipient_ids)&&(!this.user||!i.recipient_ids.includes(this.user.id))){console.log("Сообщение не предназначено для текущего пользователя");return}this.showBrowserNotification(i.title||"Уведомление",i.body||i.text||"",i.data||{}),this.triggerBroadcastEvent(i)}triggerNotificationEvent(i){const o=new CustomEvent("notification:received",{detail:i});document.dispatchEvent(o)}triggerBroadcastEvent(i){const o=new CustomEvent("broadcast:received",{detail:i});document.dispatchEvent(o)}}const r=new s;document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{r.init()},1500)});function c(){console.log("checkForNewMessages вызвана")}function a(t,i,o){console.log("showChatNotification вызвана",{title:t,message:i,data:o}),r&&r.showBrowserNotification(t,i,o)}function l(){try{if(!("Notification"in window)){console.log("Этот браузер не поддерживает уведомления");return}Notification.permission==="granted"?console.log("Разрешения на уведомления уже получены"):Notification.permission!=="denied"&&document.addEventListener("click",function t(){Notification.requestPermission(),document.removeEventListener("click",t)},{once:!0})}catch(t){console.error("Ошибка при подписке на уведомления:",t)}}export{c as checkForNewMessages,r as default,a as showChatNotification,l as subscribeToNotifications};
