import{a as m}from"./firebase-init-B_RFWMUP.js";import{g as h,o as w,a as b}from"./index.esm2017-fTSNeBOI.js";import"https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging.js";const l=h(m);var f;const p=(f=document.querySelector('meta[name="user-id"]'))==null?void 0:f.getAttribute("content");function N(){Notification.permission!=="granted"&&Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(e=>console.log("Geolocation permission granted:",e),e=>console.error("Geolocation error:",e))}document.addEventListener("DOMContentLoaded",()=>{N(),Notification.permission==="granted"&&_(),window.firebaseNotifHandlerRegistered||(w(l,e=>{var r,a,c,d;if(console.log("Получено push‑уведомление:",e),e.data&&e.data.recipient_id&&e.data.recipient_id!==p)return;const o=((r=e.data)==null?void 0:r.sender_name)||"Неизвестно",t=((a=e.data)==null?void 0:a.message_text)||((c=e.notification)==null?void 0:c.body)||"",n=`Новое сообщение от: ${o}`,s={body:`Сообщение: ${t}`,icon:((d=e.notification)==null?void 0:d.icon)||"/firebase-logo.png",tag:`global-notif-${Date.now()}`};let g=new Notification(n,s);g.onclick=function(u){u.preventDefault(),window.focus(),e.data&&e.data.chat_id&&e.data.chat_type&&(window.location.href=`/chats/${e.data.chat_type}/${e.data.chat_id}`)},new Audio("/storage/avatars/firebase-sound.mp3").play()}),window.firebaseNotifHandlerRegistered=!0),S(),window.Echo&&window.Echo.channel("global-notifications").listen(".GlobalNotification",e=>{console.log("Global notification received:",e);const o=e.title||"Уведомление",t=e.message||"";C(o,t,e.data)})});function _(){b(l,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(e=>{e?(console.log("Получен FCM токен:",e.substring(0,20)+"..."),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:e})}).then(o=>{o.ok?console.log("Токен успешно сохранён на сервере"):console.error("Ошибка при сохранении токена на сервере")}).catch(o=>console.error("Ошибка отправки токена:",o))):console.error("Не удалось получить токен FCM")}).catch(e=>console.error("Ошибка получения токена FCM:",e))}function C(e,o,t={}){t.sender_name&&t.message_text&&(e=`Новое сообщение от: ${t.sender_name}`,o=`Сообщение: ${t.message_text}`);let n=new Notification(e,{body:o,icon:"/firebase-logo.png",data:t});n.onclick=function(i){i.preventDefault(),window.focus()},new Audio("/storage/avatars/firebase-sound.mp3").play()}function S(){let e=0;setInterval(()=>{fetch("/chats/unread-counts",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(o=>{if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);return o.text()}).then(o=>{try{const t=JSON.parse(o);if(t.unread_counts&&t.unread_counts.length>0){const n=t.unread_counts.reduce((i,s)=>i+parseInt(s.unread_count||0),0);if(n>e){const i="Новые сообщения",s=`У вас появилось ${n-e} новых сообщений.`;new Notification(i,{body:s,icon:"/firebase-logo.png"})}e=n}else e=0}catch{console.error("Ошибка при получении непрочитанных сообщений: Неверный формат JSON",o)}}).catch(o=>console.error("Ошибка при получении непрочитанных сообщений:",o))},1e4)}
