import{a as C}from"./firebase-init-B_RFWMUP.js";import{g as L,o as S,a as A}from"./index.esm2017-fTSNeBOI.js";function _(e){return new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function g(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,s=>t[s])}function M(){const e=document.getElementById("chat-messages");e.scrollTop=e.scrollHeight}function p(e){document.querySelectorAll("#chat-messages ul li").forEach(t=>{t.style.display=e?t.classList.contains("pinned")?"":"none":""})}function x(e,t,s,o,a,n){const r=document.getElementById("chat-messages");if(!r){console.error("Элемент chat-messages не найден!");return}const c=r.querySelector("ul");if(!c){console.error("Список сообщений не найден в chat-messages!");return}let d="",m=!1;e.forEach(i=>{if(!s.has(i.id)){if(m=!0,i.message_type==="notification"||i.is_system)d+=`
                    <li class="system-notification" data-id="${i.id}">
                        ${i.message}
                        <span class="message-time">${_(i.created_at)}</span>
                    </li>
                `;else{const u=i.sender_id===t,N=i.message_type==="notification"?"notification-message":u?"my-message":"other-message",T=i.is_pinned?"pinned":"";let $="";u&&i.is_read&&($='<span class="read-status">✓✓</span>');let f="";i.message&&i.message.trim()!==""&&(i.message_type==="notification"?f+=i.message:f+=`<div>${g(i.message)}</div>`),i.attachments&&Array.isArray(i.attachments)&&i.attachments.length>0&&i.attachments.forEach(l=>{l&&l.mime&&l.mime.startsWith("image/")?f+=`<div><img src="${l.url}" alt="Image" loading="lazy" style="max-width:100%; border-radius:4px;" onerror="this.style.display='none'"></div>`:l&&l.url&&(f+=`<div><a href="${l.url}" target="_blank">${g(l.original_file_name||"Файл")}</a></div>`)}),f.trim()===""&&(f='<div style="color:#888;">[Пустое сообщение]</div>');let w="";u&&(w=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${i.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${i.is_pinned?`<button class="unpin-message" data-id="${i.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${i.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),d+=`
                    <li class="${N} ${T}" data-id="${i.id}">
                        <div><strong>${u?"Вы":g(i.sender_name||"Неизвестно")}</strong></div>
                        ${f}
                        ${w}
                        <span class="message-time">${_(i.created_at)}</span>
                        ${$}
                    </li>
                `}s.add(i.id)}}),d&&m&&(c.insertAdjacentHTML("beforeend",d),M(),q(o,a,n),p())}function h(e){window.Sentry?window.Sentry.captureException(e):console.error(e)}function q(e,t,s){document.querySelectorAll(".delete-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${t}/${s}/messages/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{n.success?this.closest("li").remove():alert(n.error||"Ошибка удаления сообщения")}).catch(n=>h(n))}}),document.querySelectorAll(".pin-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");fetch(`/chats/${t}/${s}/messages/${a}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{if(n.message){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let r=this.closest("li");if(r.classList.add("pinned"),r&&!r.querySelector(".pinned-label")){let c=document.createElement("span");c.classList.add("pinned-label"),c.textContent=" [Закреплено]",r.querySelector("div").appendChild(c)}p()}else console.error("Ошибка закрепления сообщения:",n.error),alert(n.error||"Ошибка закрепления сообщения")}).catch(n=>{h(n)})}}),document.querySelectorAll(".unpin-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");fetch(`/chats/${t}/${s}/messages/${a}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(n=>n.json()).then(n=>{if(n.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let r=this.closest("li");r.classList.remove("pinned");let c=r.querySelector(".pinned-label");c&&c.remove(),p()}else alert(n.error||"Ошибка открепления сообщения")}).catch(n=>h(n))}})}const b=L(C);var y;const v=(y=document.querySelector('meta[name="user-id"]'))==null?void 0:y.getAttribute("content");function I(){Notification.permission!=="granted"&&Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(e=>console.log("Geolocation permission granted:",e),e=>console.error("Geolocation error:",e))}document.addEventListener("DOMContentLoaded",()=>{I(),Notification.permission==="granted"&&H(),window.firebaseNotifHandlerRegistered||(S(b,e=>{var c,d,m,i;if(console.log("Получено push‑уведомление:",e),e.data&&e.data.recipient_id&&e.data.recipient_id!==v)return;const t=((c=e.data)==null?void 0:c.sender_name)||"Неизвестно",s=((d=e.data)==null?void 0:d.message_text)||((m=e.notification)==null?void 0:m.body)||"",o=`Новое сообщение от: ${t}`,n={body:`Сообщение: ${s}`,icon:((i=e.notification)==null?void 0:i.icon)||"/firebase-logo.png",tag:`global-notif-${Date.now()}`};let r=new Notification(o,n);r.onclick=function(u){u.preventDefault(),window.focus(),e.data&&e.data.chat_id&&e.data.chat_type&&(window.location.href=`/chats/${e.data.chat_type}/${e.data.chat_id}`)},new Audio("/storage/avatars/firebase-sound.mp3").play()}),window.firebaseNotifHandlerRegistered=!0),O(),window.Echo&&window.Echo.channel("global-notifications").listen(".GlobalNotification",e=>{console.log("Global notification received:",e);const t=e.title||"Уведомление",s=e.message||"";E(t,s,e.data)})});function H(){A(b,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(e=>{e?(console.log("Получен FCM токен:",e.substring(0,20)+"..."),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:e})}).then(t=>{t.ok?console.log("Токен успешно сохранён на сервере"):console.error("Ошибка при сохранении токена на сервере")}).catch(t=>console.error("Ошибка отправки токена:",t))):console.error("Не удалось получить токен FCM")}).catch(e=>console.error("Ошибка получения токена FCM:",e))}function E(e,t,s={}){s.sender_name&&s.message_text&&(e=`Новое сообщение от: ${s.sender_name}`,t=`Сообщение: ${s.message_text}`);let o=new Notification(e,{body:t,icon:"/firebase-logo.png",data:s});o.onclick=function(a){a.preventDefault(),window.focus()},new Audio("/storage/avatars/firebase-sound.mp3").play()}function P(){window.firebaseNotifHandlerRegistered||(S(b,e=>{var o,a,n,r;if(e.data&&e.data.recipient_id&&e.data.recipient_id!==v)return;const t=(o=e.data)!=null&&o.sender_name?`Новое сообщение от ${e.data.sender_name}`:((a=e.notification)==null?void 0:a.title)||"Новое уведомление",s=(n=e.data)!=null&&n.message_text?`Сообщение: ${e.data.message_text}`:((r=e.notification)==null?void 0:r.body)||"";E(t,s,e.data)}),window.firebaseNotifHandlerRegistered=!0)}function O(){let e=0;setInterval(()=>{fetch("/chats/unread-counts",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return t.text()}).then(t=>{try{const s=JSON.parse(t);if(s.unread_counts&&s.unread_counts.length>0){const o=s.unread_counts.reduce((a,n)=>a+parseInt(n.unread_count||0),0);if(o>e){const a="Новые сообщения",n=`У вас появилось ${o-e} новых сообщений.`;new Notification(a,{body:n,icon:"/firebase-logo.png"})}e=o}else e=0}catch{console.error("Ошибка при получении непрочитанных сообщений: Неверный формат JSON",t)}}).catch(t=>console.error("Ошибка при получении непрочитанных сообщений:",t))},1e4)}export{_ as a,P as c,p as f,x as r};
