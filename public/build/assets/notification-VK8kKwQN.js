import{a as T}from"./firebase-init-DQxvl9Em.js";import{g as C,o as v,a as L}from"./index.esm2017-BPEvCmAA.js";function _(e){return new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function g(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,s=>t[s])}function A(){const e=document.getElementById("chat-messages");e.scrollTop=e.scrollHeight}function h(e){document.querySelectorAll("#chat-messages ul li").forEach(t=>{t.style.display=e?t.classList.contains("pinned")?"":"none":""})}function U(e,t,s,o,a,i){const r=document.getElementById("chat-messages");if(!r){console.error("Элемент chat-messages не найден!");return}const c=r.querySelector("ul");if(!c){console.error("Список сообщений не найден в chat-messages!");return}let d="",m=!1;e.forEach(n=>{if(!s.has(n.id)){if(m=!0,n.message_type==="notification"||n.is_system)d+=`
                    <li class="system-notification" data-id="${n.id}">
                        ${n.message}
                        <span class="message-time">${_(n.created_at)}</span>
                    </li>
                `;else{const u=n.sender_id===t,N=n.message_type==="notification"?"notification-message":u?"my-message":"other-message",y=n.is_pinned?"pinned":"";let b="";u&&n.is_read&&(b='<span class="read-status">✓✓</span>');let f="";n.message&&n.message.trim()!==""&&(n.message_type==="notification"?f+=n.message:f+=`<div>${g(n.message)}</div>`),n.attachments&&Array.isArray(n.attachments)&&n.attachments.length>0&&n.attachments.forEach(l=>{l&&l.mime&&l.mime.startsWith("image/")?f+=`<div><img src="${l.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:l&&l.url&&(f+=`<div><a href="${l.url}" target="_blank">${g(l.original_file_name||"Файл")}</a></div>`)}),f.trim()===""&&(f='<div style="color:#888;">[Пустое сообщение]</div>');let $="";u&&($=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${n.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${n.is_pinned?`<button class="unpin-message" data-id="${n.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${n.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),d+=`
                    <li class="${N} ${y}" data-id="${n.id}">
                        <div><strong>${u?"Вы":g(n.sender_name||"Неизвестно")}</strong></div>
                        ${f}
                        ${$}
                        <span class="message-time">${_(n.created_at)}</span>
                        ${b}
                    </li>
                `}s.add(n.id)}}),d&&m&&(c.insertAdjacentHTML("beforeend",d),A(),M(o,a,i),h())}function M(e,t,s){document.querySelectorAll(".delete-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${t}/${s}/messages/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{i.success?this.closest("li").remove():alert(i.error||"Ошибка удаления сообщения")}).catch(i=>console.error("Ошибка:",i))}}),document.querySelectorAll(".pin-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");fetch(`/chats/${t}/${s}/messages/${a}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{if(i.message){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let r=this.closest("li");if(r.classList.add("pinned"),r&&!r.querySelector(".pinned-label")){let c=document.createElement("span");c.classList.add("pinned-label"),c.textContent=" [Закреплено]",r.querySelector("div").appendChild(c)}h()}else console.error("Ошибка закрепления сообщения:",i.error),alert(i.error||"Ошибка закрепления сообщения")}).catch(i=>{console.error("Ошибка при закреплении сообщения:",i)})}}),document.querySelectorAll(".unpin-message").forEach(o=>{o.onclick=function(){const a=this.getAttribute("data-id");fetch(`/chats/${t}/${s}/messages/${a}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{if(i.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let r=this.closest("li");r.classList.remove("pinned");let c=r.querySelector(".pinned-label");c&&c.remove(),h()}else alert(i.error||"Ошибка открепления сообщения")}).catch(i=>console.error("Ошибка:",i))}})}const p=C(T);var w;const S=(w=document.querySelector('meta[name="user-id"]'))==null?void 0:w.getAttribute("content");function q(){Notification.permission!=="granted"&&Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)}),"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(e=>console.log("Geolocation permission granted:",e),e=>console.error("Geolocation error:",e))}document.addEventListener("DOMContentLoaded",()=>{q(),Notification.permission==="granted"&&I(),window.firebaseNotifHandlerRegistered||(v(p,e=>{var c,d,m,n;if(console.log("Получено push‑уведомление:",e),e.data&&e.data.recipient_id&&e.data.recipient_id!==S)return;const t=((c=e.data)==null?void 0:c.sender_name)||"Неизвестно",s=((d=e.data)==null?void 0:d.message_text)||((m=e.notification)==null?void 0:m.body)||"",o=`Новое сообщение от: ${t}`,i={body:`Сообщение: ${s}`,icon:((n=e.notification)==null?void 0:n.icon)||"/firebase-logo.png",tag:`global-notif-${Date.now()}`};let r=new Notification(o,i);r.onclick=function(u){u.preventDefault(),window.focus(),e.data&&e.data.chat_id&&e.data.chat_type&&(window.location.href=`/chats/${e.data.chat_type}/${e.data.chat_id}`)},new Audio("/storage/avatars/firebase-sound.mp3").play()}),window.firebaseNotifHandlerRegistered=!0),H(),window.Echo&&window.Echo.channel("global-notifications").listen(".GlobalNotification",e=>{console.log("Global notification received:",e);const t=e.title||"Уведомление",s=e.message||"";E(t,s,e.data)})});function I(){L(p,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(e=>{e?(console.log("Получен FCM токен:",e.substring(0,20)+"..."),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:e})}).then(t=>{t.ok?console.log("Токен успешно сохранён на сервере"):console.error("Ошибка при сохранении токена на сервере")}).catch(t=>console.error("Ошибка отправки токена:",t))):console.error("Не удалось получить токен FCM")}).catch(e=>console.error("Ошибка получения токена FCM:",e))}function E(e,t,s={}){s.sender_name&&s.message_text&&(e=`Новое сообщение от: ${s.sender_name}`,t=`Сообщение: ${s.message_text}`);let o=new Notification(e,{body:t,icon:"/firebase-logo.png",data:s});o.onclick=function(a){a.preventDefault(),window.focus()},new Audio("/storage/avatars/firebase-sound.mp3").play()}function P(){window.firebaseNotifHandlerRegistered||(v(p,e=>{var o,a,i,r;if(e.data&&e.data.recipient_id&&e.data.recipient_id!==S)return;const t=(o=e.data)!=null&&o.sender_name?`Новое сообщение от ${e.data.sender_name}`:((a=e.notification)==null?void 0:a.title)||"Новое уведомление",s=(i=e.data)!=null&&i.message_text?`Сообщение: ${e.data.message_text}`:((r=e.notification)==null?void 0:r.body)||"";E(t,s,e.data)}),window.firebaseNotifHandlerRegistered=!0)}function H(){let e=0;setInterval(()=>{fetch("/chats/unread-counts",{method:"GET",credentials:"same-origin",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return t.text()}).then(t=>{try{const s=JSON.parse(t);if(s.unread_counts&&s.unread_counts.length>0){const o=s.unread_counts.reduce((a,i)=>a+parseInt(i.unread_count||0),0);if(o>e){const a="Новые сообщения",i=`У вас появилось ${o-e} новых сообщений.`;new Notification(a,{body:i,icon:"/firebase-logo.png"})}e=o}else e=0}catch{console.error("Ошибка при получении непрочитанных сообщений: Неверный формат JSON",t)}}).catch(t=>console.error("Ошибка при получении непрочитанных сообщений:",t))},1e4)}export{_ as a,P as c,h as f,U as r};
